# ============================================
# start_celery_worker.sh
# Ğ—Ğ°Ğ¿ÑƒÑĞº Celery worker Ğ´Ğ»Ñ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
# ============================================
#!/bin/bash

# ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ñ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµĞ¼
cd /home/argentum/GolandProjects/vpn/vpn/celery_app

# ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ (ĞµÑĞ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ)
# source venv/bin/activate

#pip install --upgrade pip setuptools wheel
#pip install celery[redis]==5.3.4
#pip install fastapi==0.104.1 uvicorn==0.24.0 redis==5.0.1 \
            #psycopg2-binary==2.9.9 psutil==5.9.6 flower==2.0.1 \
            #jinja2==3.1.2 python-multipart==0.0.6

# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Celery worker
celery -A tasks worker \
    --loglevel=info \
    --concurrency=4 \
    --hostname=scanner@%h \
    --queues=default \
    --max-tasks-per-child=50 \
    --time-limit=3600 \
    --soft-time-limit=3300

# ============================================
# start_celery_beat.sh
# Ğ—Ğ°Ğ¿ÑƒÑĞº Celery beat Ğ´Ğ»Ñ Ğ¿ĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡
# ============================================
#!/bin/bash

cd /home/argentum/GolandProjects/vpn/vpn/celery_app

# source venv/bin/activate

celery -A tasks beat \
    --loglevel=info \
    --scheduler=celery.beat:PersistentScheduler

# ============================================
# start_flower.sh
# Ğ—Ğ°Ğ¿ÑƒÑĞº Flower Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Celery
# ============================================
#!/bin/bash

cd /home/argentum/GolandProjects/vpn/vpn/celery_app

# source venv/bin/activate

celery -A tasks flower \
    --port=5555 \
    --broker=redis://localhost:6379/0

# Flower Ğ±ÑƒĞ´ĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ½Ğ° http://localhost:5555

# ============================================
# start_fastapi.sh
# Ğ—Ğ°Ğ¿ÑƒÑĞº FastAPI Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
# ============================================
#!/bin/bash

cd /home/argentum/GolandProjects/vpn/vpn/web

# source venv/bin/activate

uvicorn main:app \
    --host 0.0.0.0 \
    --port 8000 \
    --reload

# ============================================
# systemd service Ñ„Ğ°Ğ¹Ğ»Ñ‹
# ============================================

# /etc/systemd/system/celery-worker.service
cat > /tmp/celery-worker.service << 'EOF'
[Unit]
Description=Celery Worker for VPN Scanner
After=network.target redis.service postgresql.service

[Service]
Type=forking
User=argentum
Group=argentum
WorkingDirectory=/home/argentum/GolandProjects/vpn/vpn/celery_app
ExecStart=/usr/local/bin/celery -A tasks worker \
    --loglevel=info \
    --concurrency=4 \
    --hostname=scanner@%%h \
    --pidfile=/var/run/celery/worker.pid \
    --logfile=/var/log/celery/worker.log
ExecStop=/bin/kill -TERM $MAINPID
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# /etc/systemd/system/celery-beat.service
cat > /tmp/celery-beat.service << 'EOF'
[Unit]
Description=Celery Beat Scheduler
After=network.target redis.service

[Service]
Type=simple
User=argentum
Group=argentum
WorkingDirectory=/home/argentum/GolandProjects/vpn/vpn/celery_app
ExecStart=/usr/local/bin/celery -A tasks beat \
    --loglevel=info \
    --pidfile=/var/run/celery/beat.pid \
    --logfile=/var/log/celery/beat.log
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# /etc/systemd/system/fastapi-vpn.service
cat > /tmp/fastapi-vpn.service << 'EOF'
[Unit]
Description=FastAPI VPN Web Interface
After=network.target postgresql.service

[Service]
Type=simple
User=argentum
Group=argentum
WorkingDirectory=/home/argentum/GolandProjects/vpn/vpn/web
ExecStart=/usr/local/bin/uvicorn main:app \
    --host 0.0.0.0 \
    --port 8000
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# ============================================
# install_services.sh
# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° systemd ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
# ============================================
#!/bin/bash

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸
sudo mkdir -p /var/run/celery
sudo mkdir -p /var/log/celery
sudo chown -R argentum:argentum /var/run/celery
sudo chown -R argentum:argentum /var/log/celery

# ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ service Ñ„Ğ°Ğ¹Ğ»Ñ‹
sudo cp /tmp/celery-worker.service /etc/systemd/system/
sudo cp /tmp/celery-beat.service /etc/systemd/system/
sudo cp /tmp/fastapi-vpn.service /etc/systemd/system/

# ĞŸĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ systemd
sudo systemctl daemon-reload

# Ğ’ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°Ğ¿ÑƒÑĞº
sudo systemctl enable celery-worker
sudo systemctl enable celery-beat
sudo systemctl enable fastapi-vpn

# Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
sudo systemctl start celery-worker
sudo systemctl start celery-beat
sudo systemctl start fastapi-vpn

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
sudo systemctl status celery-worker
sudo systemctl status celery-beat
sudo systemctl status fastapi-vpn

echo "âœ… Services installed and started"
echo "ğŸ“Š Monitor with: sudo journalctl -u celery-worker -f"
echo "ğŸŒ¸ Flower UI: celery -A tasks flower --port=5555"

# ============================================
# requirements.txt
# Ğ—Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Python
# ============================================
cat > /tmp/requirements.txt << 'EOF'
fastapi==0.104.1
uvicorn==0.24.0
celery==5.3.4
redis==5.0.1
psycopg2-binary==2.9.9
psutil==5.9.6
flower==2.0.1
jinja2==3.1.2
python-multipart==0.0.6
EOF

# ============================================
# install_dependencies.sh
# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
# ============================================
#!/bin/bash

# ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ
sudo apt update

# Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Redis
sudo apt install -y redis-server
sudo systemctl enable redis-server
sudo systemctl start redis-server

# Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Python Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
pip install -r requirements.txt

# ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Redis
redis-cli ping  # Ğ”Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒ PONG

echo "âœ… Dependencies installed"

# ============================================
# monitor.sh
# ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
# ============================================
#!/bin/bash

echo "=== VPN Scanner System Status ==="
echo ""

echo "ğŸ“Š PostgreSQL:"
sudo systemctl status postgresql --no-pager | grep "Active:"
echo ""

echo "ğŸ”´ Redis:"
sudo systemctl status redis-server --no-pager | grep "Active:"
redis-cli ping
echo ""

echo "ğŸ‘· Celery Worker:"
sudo systemctl status celery-worker --no-pager | grep "Active:"
celery -A tasks inspect active 2>/dev/null | grep -E "^\[|  - " || echo "No active tasks"
echo ""

echo "â° Celery Beat:"
sudo systemctl status celery-beat --no-pager | grep "Active:"
echo ""

echo "ğŸŒ FastAPI:"
sudo systemctl status fastapi-vpn --no-pager | grep "Active:"
curl -s http://localhost:8000/ > /dev/null && echo "âœ… HTTP OK" || echo "âŒ HTTP FAIL"
echo ""

echo "ğŸ“ˆ Database Stats:"
psql -U brute -d brute_system -h localhost -p 5434 << 'SQL'
SELECT 
    (SELECT COUNT(*) FROM scan_jobs WHERE status = 'pending') as pending_jobs,
    (SELECT COUNT(*) FROM scan_jobs WHERE status = 'running') as running_jobs,
    (SELECT COUNT(*) FROM scan_jobs WHERE status = 'completed') as completed_jobs,
    (SELECT COUNT(*) FROM scanned_addresses WHERE is_checked = false) as unchecked_addresses,
    (SELECT COUNT(*) FROM vpns) as total_vpns;
SQL

echo ""
echo "ğŸŒ¸ Flower UI: http://localhost:5555"
echo "ğŸ“± FastAPI: http://localhost:8000"
