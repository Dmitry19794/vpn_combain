#!/bin/bash
# migrate_db.sh.example ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —à–∞–±–ª–æ–Ω (–±–µ–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤!)
# –ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤ migrate_db.sh –∏ –∑–∞–¥–∞–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
#
#   export LOCAL_PG_USER=brute
#   export LOCAL_PG_PASS=securepass123
#   export REMOTE_PG_USER=brute
#   export REMOTE_PG_PASS=securepass123
#   export REMOTE_HOST=213.171.31.97
#   export PGPORT_LOCAL=5434   # –∏–ª–∏ 5432
#   export PGPORT_REMOTE=5432
#
# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π .env —Ñ–∞–π–ª –∏ `source .env`

set -euo pipefail

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤—Å–µ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è) ===
LOCAL_PG_USER="${LOCAL_PG_USER:-brute}"
LOCAL_PG_PASS="${LOCAL_PG_PASS:-}"
LOCAL_DB_NAME="${LOCAL_DB_NAME:-brute_system}"
PGPORT_LOCAL="${PGPORT_LOCAL:-5432}"

REMOTE_PG_USER="${REMOTE_PG_USER:-brute}"
REMOTE_PG_PASS="${REMOTE_PG_PASS:-}"
REMOTE_DB_NAME="${REMOTE_DB_NAME:-brute_system}"
REMOTE_HOST="${REMOTE_HOST:-213.171.31.97}"
PGPORT_REMOTE="${PGPORT_REMOTE:-5432}"

DUMP_FILE="${DUMP_FILE:-brute_system.sql}"

# === –§—É–Ω–∫—Ü–∏–∏ ===
log() { echo "[$(date +%H:%M:%S)] $*"; }

# === 1. –î–∞–º–ø –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î ===
log "üîß Dumping local database \"\$LOCAL_DB_NAME\" from port \$PGPORT_LOCAL..."
export PGPASSWORD="\$LOCAL_PG_PASS"
pg_dump -h localhost -p "\$PGPORT_LOCAL" -U "\$LOCAL_PG_USER" -d "\$LOCAL_DB_NAME" --no-owner --no-privileges -f "\$DUMP_FILE"
log "‚úÖ Local dump saved to \$DUMP_FILE"

# === 2. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω—ã–π —Å–µ—Ä–≤–µ—Ä ===
log "üì§ Transferring dump to \$REMOTE_HOST..."
scp -o ServerAliveInterval=30 "\$DUMP_FILE" "admin@\$REMOTE_HOST:/tmp/"

# === 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ ===
log "üîÑ Restoring on remote server \$REMOTE_HOST..."
ssh -o ServerAliveInterval=30 "admin@\$REMOTE_HOST" << REMOTE_SSH
  set -euo pipefail
  export PGPASSWORD="\$REMOTE_PG_PASS"

  # –°–æ–∑–¥–∞—ë–º —Ä–æ–ª—å, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  sudo -u postgres psql -p \$PGPORT_REMOTE -c "CREATE USER \$REMOTE_PG_USER WITH PASSWORD '\$REMOTE_PG_PASS' SUPERUSER;" 2>/dev/null || true

  # –°–æ–∑–¥–∞—ë–º –ë–î, –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  sudo -u postgres psql -p \$PGPORT_REMOTE -c "CREATE DATABASE \$REMOTE_DB_NAME OWNER \$REMOTE_PG_USER;" 2>/dev/null || true

  # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–º–ø
  psql -h localhost -p \$PGPORT_REMOTE -U \$REMOTE_PG_USER -d \$REMOTE_DB_NAME -f /tmp/\$DUMP_FILE
  rm -f /tmp/\$DUMP_FILE
REMOTE_SSH

log "‚úÖ Migration completed!"
