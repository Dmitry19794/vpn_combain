<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>üåç –ü—Ä–æ–∫—Å–∏ (Real-time)</h3>
        
        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Proxy Checker -->
        <div style="display: flex; gap: 10px;">
            <button hx-post="/proxy-checker-start" 
                    hx-swap="none"
                    class="btn btn-success">
                ‚ñ∂ Start Checker
            </button>
            <button hx-post="/proxy-checker-pause" 
                    hx-swap="none"
                    class="btn btn-warning">
                ‚è∏ Pause
            </button>
            <button hx-post="/proxy-checker-resume" 
                    hx-swap="none"
                    class="btn btn-info">
                ‚ñ∂ Resume
            </button>
            <button hx-post="/proxy-checker-stop" 
                    hx-swap="none"
                    class="btn btn-danger">
                ‚èπ Stop
            </button>
        </div>
    </div>
    
    <!-- –°—Ç–∞—Ç—É—Å Proxy Checker -->
    <div style="padding: 15px; background: rgba(0,0,0,0.03); border-radius: 8px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong>–°—Ç–∞—Ç—É—Å:</strong> 
                <span id="proxy-checker-status-main" 
                      hx-get="/proxy-checker-status" 
                      hx-trigger="every 3s"
                      hx-swap="innerHTML">
                    Loading...
                </span>
            </div>
            <div style="font-size: 0.9em; opacity: 0.7;">
                <span id="proxy-checker-logs-main" 
                      hx-get="/proxy-checker-logs" 
                      hx-trigger="every 3s"
                      hx-swap="innerHTML">
                </span>
            </div>
        </div>
    </div>
    
    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–∫—Å–∏ -->
    <details style="margin-bottom: 20px;">
        <summary style="cursor: pointer; padding: 10px; background: rgba(0,0,0,0.03); border-radius: 5px;">
            üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–∫—Å–∏ –∏–∑ —Ñ–∞–π–ª–∞
        </summary>
        <div style="padding: 15px; border: 1px solid rgba(0,0,0,0.1); border-top: none; border-radius: 0 0 5px 5px;">
            <form hx-post="/upload-proxies" 
                  hx-encoding="multipart/form-data"
                  hx-target="#upload-result"
                  hx-swap="innerHTML">
                <div style="display: flex; gap: 10px; align-items: end;">
                    <div style="flex: 1;">
                        <label>–§–∞–π–ª (host:port)</label>
                        <input type="file" name="file" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div>
                        <label>GEO</label>
                        <select name="geo" required style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                            <option value="US">US</option>
                            <option value="EU">EU</option>
                            <option value="ASIA">ASIA</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </div>
            </form>
            <div id="upload-result" style="margin-top: 10px;"></div>
        </div>
    </details>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div style="display: flex; gap: 15px; margin: 20px 0; flex-wrap: wrap;">
        <div style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px;">
            <strong id="rt-proxies-alive">-</strong> –∂–∏–≤—ã—Ö
        </div>
        <div style="padding: 10px 20px; background: rgba(0,0,0,0.1); border-radius: 8px;">
            <strong id="rt-proxies-total">-</strong> –≤—Å–µ–≥–æ
        </div>
        <div style="padding: 10px 20px; background: rgba(0,0,0,0.05); border-radius: 8px;">
            <span id="rt-proxies-dead">-</span> –º–µ—Ä—Ç–≤—ã—Ö
        </div>
    </div>
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: rgba(0,0,0,0.05);">
                    <th style="padding: 12px; text-align: left;">Host</th>
                    <th style="padding: 12px; text-align: left;">Port</th>
                    <th style="padding: 12px; text-align: left;">GEO</th>
                    <th style="padding: 12px; text-align: left;">Anonymity</th>
                    <th style="padding: 12px; text-align: left;">Speed</th>
                    <th style="padding: 12px; text-align: left;">Status</th>
                </tr>
            </thead>
            <tbody id="proxy-table-body">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                        –ó–∞–≥—Ä—É–∑–∫–∞...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<style>
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.2s;
    font-weight: 500;
}

.btn-success {
    background: #4caf50;
    color: white;
}

.btn-success:hover {
    background: #45a049;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
}

.btn-warning {
    background: #ff9800;
    color: white;
}

.btn-warning:hover {
    background: #e68900;
}

.btn-info {
    background: #2196f3;
    color: white;
}

.btn-info:hover {
    background: #0b7dda;
}

.btn-danger {
    background: #f44336;
    color: white;
}

.btn-danger:hover {
    background: #da190b;
}

.btn-primary {
    background: #667eea;
    color: white;
}

.btn-primary:hover {
    background: #5568d3;
}

#proxy-table-body tr {
    border-bottom: 1px solid rgba(0,0,0,0.05);
    transition: background 0.2s;
}

#proxy-table-body tr:hover {
    background: rgba(0,0,0,0.02);
}

#proxy-table-body td {
    padding: 12px;
}

.proxy-alive {
    opacity: 1;
}

.proxy-dead {
    opacity: 0.4;
}

.status-alive {
    color: #4caf50;
    font-weight: bold;
}

.status-dead {
    color: #f44336;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.proxy-row-new {
    animation: fadeIn 0.5s ease-out;
}
</style>

<script>
// WebSocket –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ–∫—Å–∏
let proxyTableWs = null;
let proxyReconnectTimeout = null;

function connectProxyTableWebSocket() {
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/proxy-table`;
    
    proxyTableWs = new WebSocket(wsUrl);
    
    proxyTableWs.onopen = function() {
        console.log('‚úÖ Proxy table WebSocket connected');
    };
    
    proxyTableWs.onmessage = function(event) {
        const message = JSON.parse(event.data);
        
        if (message.type === 'proxy_table_update') {
            updateProxyTable(message.data);
        }
    };
    
    proxyTableWs.onerror = function(error) {
        console.error('‚ùå Proxy table WebSocket error:', error);
    };
    
    proxyTableWs.onclose = function() {
        console.log('üî¥ Proxy table WebSocket disconnected');
        proxyReconnectTimeout = setTimeout(connectProxyTableWebSocket, 3000);
    };
}

function updateProxyTable(proxies) {
    const tbody = document.getElementById('proxy-table-body');
    
    if (!proxies || proxies.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: #999;">
                    –ù–µ—Ç –ø—Ä–æ–∫—Å–∏. –ó–∞–ø—É—Å—Ç–∏—Ç–µ Proxy Checker –¥–ª—è —Å–±–æ—Ä–∞.
                </td>
            </tr>
        `;
        return;
    }
    
    // –°—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const aliveCount = proxies.filter(p => p.is_alive).length;
    const deadCount = proxies.length - aliveCount;
    
    document.getElementById('rt-proxies-alive').textContent = aliveCount;
    document.getElementById('rt-proxies-total').textContent = proxies.length;
    document.getElementById('rt-proxies-dead').textContent = deadCount;
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º HTML —Ç–∞–±–ª–∏—Ü—ã
    const html = proxies.map((proxy, index) => {
        const rowClass = proxy.is_alive ? 'proxy-alive' : 'proxy-dead';
        const statusIcon = proxy.is_alive ? 'üü¢' : 'üî¥';
        const statusClass = proxy.is_alive ? 'status-alive' : 'status-dead';
        const speedColor = proxy.is_alive ? '#4caf50' : '#999';
        
        return `
            <tr class="${rowClass} proxy-row-new" style="animation-delay: ${index * 0.02}s;">
                <td style="font-family: monospace;">${proxy.host}</td>
                <td>${proxy.port}</td>
                <td><strong>${proxy.geo}</strong></td>
                <td>${proxy.anonymity}</td>
                <td style="color: ${speedColor};">${proxy.speed_ms ? proxy.speed_ms + 'ms' : '-'}</td>
                <td class="${statusClass}">${statusIcon} ${proxy.last_check}</td>
            </tr>
        `;
    }).join('');
    
    tbody.innerHTML = html;
}

// –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
connectProxyTableWebSocket();

// –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && (!proxyTableWs || proxyTableWs.readyState !== WebSocket.OPEN)) {
        connectProxyTableWebSocket();
    }
});

// –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ —É—Ö–æ–¥–µ
window.addEventListener('beforeunload', function() {
    if (proxyTableWs) {
        proxyTableWs.close();
    }
    if (proxyReconnectTimeout) {
        clearTimeout(proxyReconnectTimeout);
    }
});
</script>
