<div class="card">
    <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (Real-time)</h3>
    
    <!-- –ú–µ—Ç—Ä–∏–∫–∏ -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0;">
        
        <!-- –ü—Ä–æ–∫—Å–∏ -->
        <div class="metric-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">
            <div style="font-size: 0.9em; opacity: 0.9;">üåç –ü—Ä–æ–∫—Å–∏ (–ñ–∏–≤—ã–µ)</div>
            <div id="proxies-alive" style="font-size: 2em; font-weight: bold; margin: 10px 0;">-</div>
            <div style="font-size: 0.8em; opacity: 0.7;">–í—Å–µ–≥–æ: <span id="proxies-total">-</span></div>
        </div>
        
        <!-- VPN -->
        <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white;">
            <div style="font-size: 0.9em; opacity: 0.9;">üîê VPN</div>
            <div id="vpns-count" style="font-size: 2em; font-weight: bold; margin: 10px 0;">-</div>
            <div style="font-size: 0.8em; opacity: 0.7;">
                New: <span id="vpns-new">-</span> | 
                Checked: <span id="vpns-checked">-</span>
            </div>
        </div>
        
        <!-- Credentials -->
        <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; color: white;">
            <div style="font-size: 0.9em; opacity: 0.9;">üîë Credentials</div>
            <div id="cred-groups" style="font-size: 2em; font-weight: bold; margin: 10px 0;">-</div>
            <div style="font-size: 0.8em; opacity: 0.7;">
                Logins: <span id="logins">-</span> | 
                Passwords: <span id="passwords">-</span>
            </div>
        </div>
        
        <!-- Scan Jobs -->
        <div class="metric-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 10px; color: white;">
            <div style="font-size: 0.9em; opacity: 0.9;">üîç Scan Jobs</div>
            <div id="scan-jobs-active" style="font-size: 2em; font-weight: bold; margin: 10px 0;">-</div>
            <div style="font-size: 0.8em; opacity: 0.7;">Active</div>
        </div>
        
    </div>
    
    <!-- –ü—Ä–æ–∫—Å–∏ –ø–æ GEO -->
    <div style="margin: 20px 0;">
        <h4 style="margin-bottom: 10px;">üåç –ü—Ä–æ–∫—Å–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∞–º</h4>
        <div id="proxies-by-geo" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <!-- –ë—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ WebSocket -->
        </div>
    </div>
    
    <!-- –°–¢–ê–¢–£–° –°–ï–†–í–ò–°–û–í (–ø–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
    <div style="margin: 20px 0;">
        <h4 style="margin-bottom: 10px;">‚öôÔ∏è –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤</h4>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            
            <!-- Celery -->
            <div class="service-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="celery-status">üî¥ Celery: Offline</span>
                    <span id="celery-info" style="font-size: 0.8em; opacity: 0.7;"></span>
                </div>
            </div>
            
            <!-- Database -->
            <div class="service-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="db-status">üî¥ Database: Offline</span>
                    <span id="db-info" style="font-size: 0.8em; opacity: 0.7;"></span>
                </div>
            </div>
            
            <!-- Frontend -->
            <div class="service-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="frontend-status">üü¢ Frontend: Online</span>
                    <span style="font-size: 0.8em; opacity: 0.7;">FastAPI</span>
                </div>
            </div>
            
            <!-- Brute -->
            <div class="service-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="brute-status">‚ö™ Brute: Idle</span>
                    <span id="brute-info" style="font-size: 0.8em; opacity: 0.7;"></span>
                </div>
            </div>
            
            <!-- VPN Checker -->
            <div class="service-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="checker-status">‚ö™ VPN Checker: Idle</span>
                    <span id="checker-info" style="font-size: 0.8em; opacity: 0.7;"></span>
                </div>
            </div>
            
            <!-- Proxy Checker -->
            <div class="service-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span id="proxy-checker-status-text">üî¥ Proxy Checker: Stopped</span>
                    <div style="display: flex; gap: 5px;">
                        <button hx-post="/proxy-checker-start" 
                                hx-swap="none"
                                class="btn-mini btn-success" 
                                title="Start">‚ñ∂</button>
                        <button hx-post="/proxy-checker-pause" 
                                hx-swap="none"
                                class="btn-mini btn-warning" 
                                title="Pause">‚è∏</button>
                        <button hx-post="/proxy-checker-stop" 
                                hx-swap="none"
                                class="btn-mini btn-danger" 
                                title="Stop">‚èπ</button>
                    </div>
                </div>
                <div id="proxy-checker-logs" style="font-size: 0.8em; margin-top: 5px; opacity: 0.7;"></div>
            </div>
            
        </div>
    </div>
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket -->
    <div id="ws-connection-status" style="position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #4caf50; color: white; border-radius: 5px; display: none; z-index: 9999;">
        üü¢ Connected
    </div>
</div>

<style>
.metric-card {
    transition: transform 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.metric-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.2);
}

.geo-badge {
    display: inline-block;
    padding: 8px 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px;
    font-size: 0.9em;
}

.service-card {
    padding: 12px 15px;
    background: rgba(0,0,0,0.03);
    border-radius: 8px;
    border-left: 3px solid transparent;
    transition: all 0.2s;
}

.service-card:hover {
    background: rgba(0,0,0,0.05);
    border-left-color: #667eea;
}

.btn-mini {
    padding: 4px 8px;
    font-size: 0.8em;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-success {
    background: #4caf50;
    color: white;
}

.btn-success:hover {
    background: #45a049;
}

.btn-warning {
    background: #ff9800;
    color: white;
}

.btn-warning:hover {
    background: #e68900;
}

.btn-danger {
    background: #f44336;
    color: white;
}

.btn-danger:hover {
    background: #da190b;
}

#ws-connection-status {
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.metric-updating {
    animation: pulse 0.5s ease-in-out;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
</style>

<script>
// WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –º–µ—Ç—Ä–∏–∫
let metricsWs = null;
let reconnectTimeout = null;

function connectMetricsWebSocket() {
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/metrics`;
    
    metricsWs = new WebSocket(wsUrl);
    
    metricsWs.onopen = function() {
        console.log('‚úÖ WebSocket connected');
        showConnectionStatus('üü¢ Connected', '#4caf50');
    };
    
    metricsWs.onmessage = function(event) {
        const message = JSON.parse(event.data);
        
        if (message.type === 'metrics_update') {
            updateMetrics(message.data);
        } else if (message.type === 'error') {
            console.error('WebSocket error:', message.message);
        }
    };
    
    metricsWs.onerror = function(error) {
        console.error('‚ùå WebSocket error:', error);
    };
    
    metricsWs.onclose = function() {
        console.log('üî¥ WebSocket disconnected');
        showConnectionStatus('üî¥ Reconnecting...', '#f44336');
        reconnectTimeout = setTimeout(connectMetricsWebSocket, 3000);
    };
}

function showConnectionStatus(text, color) {
    const status = document.getElementById('ws-connection-status');
    status.style.display = 'block';
    status.style.background = color;
    status.textContent = text;
    
    if (color === '#4caf50') {
        setTimeout(() => {
            status.style.display = 'none';
        }, 3000);
    }
}

function updateMetrics(data) {
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
    const animateElement = (id, value) => {
        const el = document.getElementById(id);
        if (el) {
            el.classList.add('metric-updating');
            el.textContent = value.toLocaleString();
            setTimeout(() => el.classList.remove('metric-updating'), 500);
        }
    };
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
    animateElement('proxies-alive', data.proxies_alive);
    animateElement('proxies-total', data.proxies_total);
    animateElement('vpns-count', data.vpns);
    animateElement('cred-groups', data.cred_groups);
    animateElement('logins', data.logins);
    animateElement('passwords', data.passwords);
    animateElement('scan-jobs-active', data.scan_jobs_active);
    
    // VPN –ø–æ —Å—Ç–∞—Ç—É—Å—É
    if (data.vpns_by_status) {
        document.getElementById('vpns-new').textContent = data.vpns_by_status.new || 0;
        document.getElementById('vpns-checked').textContent = data.vpns_by_status.checked || 0;
    }
    
    // –ü—Ä–æ–∫—Å–∏ –ø–æ GEO
    if (data.proxies_by_geo) {
        const geoContainer = document.getElementById('proxies-by-geo');
        geoContainer.innerHTML = data.proxies_by_geo.map(item => `
            <div class="geo-badge">
                <strong>${item.geo}</strong>: ${item.count}
            </div>
        `).join('');
    }
    
    // –°—Ç–∞—Ç—É—Å Celery
    const celeryEl = document.getElementById('celery-status');
    if (data.celery_online) {
        celeryEl.innerHTML = 'üü¢ Celery: Online';
        celeryEl.style.color = '#4caf50';
    } else {
        celeryEl.innerHTML = 'üî¥ Celery: Offline';
        celeryEl.style.color = '#f44336';
    }
    
    // –°—Ç–∞—Ç—É—Å Database (–≤—Å–µ–≥–¥–∞ online –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç)
    const dbEl = document.getElementById('db-status');
    dbEl.innerHTML = 'üü¢ Database: Online';
    dbEl.style.color = '#4caf50';
    
    // –°—Ç–∞—Ç—É—Å Proxy Checker
    const checkerEl = document.getElementById('proxy-checker-status-text');
    if (data.proxy_checker_running) {
        checkerEl.innerHTML = 'üü¢ Proxy Checker: Running';
        checkerEl.style.color = '#4caf50';
    } else {
        checkerEl.innerHTML = 'üî¥ Proxy Checker: Stopped';
        checkerEl.style.color = '#f44336';
    }
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å/–ª–æ–≥–∏ Proxy Checker –æ—Ç–¥–µ–ª—å–Ω–æ
setInterval(function() {
    fetch('/proxy-checker-status')
        .then(r => r.text())
        .then(html => {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –µ—Å—Ç—å
            const el = document.getElementById('proxy-checker-status-text');
            if (el && html) {
                el.innerHTML = html;
            }
        });
        
    fetch('/proxy-checker-logs')
        .then(r => r.text())
        .then(html => {
            const el = document.getElementById('proxy-checker-logs');
            if (el && html) {
                el.innerHTML = html;
            }
        });
}, 5000);

// –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
connectMetricsWebSocket();

// –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
document.addEventListener('visibilitychange', function() {
    if (!document.hidden && (!metricsWs || metricsWs.readyState !== WebSocket.OPEN)) {
        connectMetricsWebSocket();
    }
});

// –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('beforeunload', function() {
    if (metricsWs) {
        metricsWs.close();
    }
    if (reconnectTimeout) {
        clearTimeout(reconnectTimeout);
    }
});
</script>
